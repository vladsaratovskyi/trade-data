{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Trades</h2>
  <div>
    <a class="btn btn-primary" href="{% url 'trades:add' %}">Add Trade</a>
    <a class="btn btn-outline-secondary" href="{% url 'trades:list' %}">Reset Filters</a>
  </div>
 </div>

<div class="row g-4">
  <aside class="col-lg-3">
    <div class="card">
      <div class="card-header">Stats</div>
      <div class="card-body">
        <div class="d-flex justify-content-between"><span class="text-muted">Total</span><span class="fw-semibold">{{ stats.total }}</span></div>
        <div class="d-flex justify-content-between"><span class="text-muted">Wins</span><span class="text-success fw-semibold">{{ stats.wins }}</span></div>
        <div class="d-flex justify-content-between"><span class="text-muted">Losses</span><span class="text-danger fw-semibold">{{ stats.losses }}</span></div>
        <hr class="my-2">
        <div class="d-flex justify-content-between"><span class="text-muted">Win rate</span><span class="fw-semibold">{{ stats.win_rate|floatformat:1 }}%</span></div>
        <div class="d-flex justify-content-between"><span class="text-muted">Avg R/R</span><span class="fw-semibold">{{ stats.avg_rr|floatformat:2 }}</span></div>
        <div class="d-flex justify-content-between"><span class="text-muted">Avg risk %</span><span class="fw-semibold">{{ stats.avg_risk_pct|floatformat:2 }}%</span></div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header">By Type</div>
      <ul class="list-group list-group-flush">
        {% for row in stats.by_type %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ row.type|capfirst }}</span>
            <span class="small text-muted">{{ row.wins }}/{{ row.total }} • {{ row.avg_rr|floatformat:2 }}</span>
          </li>
        {% empty %}
          <li class="list-group-item text-muted">—</li>
        {% endfor %}
      </ul>
    </div>

    <div class="card mt-3">
      <div class="card-header">By Direction</div>
      <ul class="list-group list-group-flush">
        {% for row in stats.by_direction %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ row.direction|capfirst }}</span>
            <span class="small text-muted">{{ row.wins }}/{{ row.total }} • {{ row.avg_rr|floatformat:2 }}</span>
          </li>
        {% empty %}
          <li class="list-group-item text-muted">—</li>
        {% endfor %}
      </ul>
    </div>
  </aside>

  <div class="col-lg-9">

<form method="get" class="card mb-4 p-3">
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label fw-semibold">Type</label>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="type" id="t-crypto" value="crypto" {% if 'crypto' in selected_types %}checked{% endif %}>
        <label class="form-check-label" for="t-crypto">Crypto</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="type" id="t-forex" value="forex" {% if 'forex' in selected_types %}checked{% endif %}>
        <label class="form-check-label" for="t-forex">Forex</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="type" id="t-index" value="index" {% if 'index' in selected_types %}checked{% endif %}>
        <label class="form-check-label" for="t-index">Index</label>
      </div>
    </div>

    <div class="col-md-3">
      <label class="form-label fw-semibold">Result</label>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="result" id="r-take" value="take" {% if 'take' in selected_results %}checked{% endif %}>
        <label class="form-check-label" for="r-take">Take</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="result" id="r-loss" value="loss" {% if 'loss' in selected_results %}checked{% endif %}>
        <label class="form-check-label" for="r-loss">Loss</label>
      </div>
    </div>

    <div class="col-md-3">
      <label class="form-label fw-semibold">Direction</label>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="direction" id="d-long" value="long" {% if 'long' in selected_directions %}checked{% endif %}>
        <label class="form-check-label" for="d-long">Long</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="direction" id="d-short" value="short" {% if 'short' in selected_directions %}checked{% endif %}>
        <label class="form-check-label" for="d-short">Short</label>
      </div>
    </div>

    <div class="col-md-3">
      <label class="form-label fw-semibold">Tags</label>
      <div class="border rounded p-2" style="max-height: 160px; overflow-y: auto;">
        {% for tag in all_tags %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="tags" id="tag-{{tag.id}}" value="{{tag.id}}" {% if tag.id in selected_tags %}checked{% endif %}>
            <label class="form-check-label" for="tag-{{tag.id}}">{{ tag.name }}</label>
          </div>
        {% empty %}
          <p class="text-muted mb-0">No tags yet.</p>
        {% endfor %}
      </div>
    </div>

  </div>
  <div class="row g-3 mt-1">
    <div class="col-md-3">
      <label class="form-label fw-semibold" for="symbol-input">Symbol</label>
      <input id="symbol-input" class="form-control" type="text" name="symbol" value="{{ q_symbol }}" list="symbols" placeholder="e.g., ETH/USDT">
      <datalist id="symbols">
        {% for s in all_symbols %}
          {% if s %}<option value="{{ s }}">{% endif %}
        {% endfor %}
      </datalist>
    </div>
    <div class="col-12">
      <button class="btn btn-success" type="submit">Apply Filters</button>
    </div>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-sm table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Symbol</th>
        <th>Dir</th>
        <th>Price</th>
        <th>SL</th>
        <th>Volume</th>
        <th>Result</th>
        <th>Risk %</th>
        <th>R/R</th>
        <th>Images</th>
        <th>Tags</th>
        <th>Comment</th>
        <th class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for t in trades %}
      <tr>
        <td>{{ t.date|date:"Y-m-d H:i" }}</td>
        <td>{{ t.get_type_display }}</td>
        <td>{{ t.symbol }}</td>
        <td>{{ t.get_direction_display }}</td>
        <td>{{ t.price }}</td>
        <td>{{ t.stop_loss_price }}</td>
        <td>{{ t.volume }}</td>
        <td>
          {% if t.result == 'take' %}
            <span class="badge bg-success">Take</span>
          {% else %}
            <span class="badge bg-danger">Loss</span>
          {% endif %}
        </td>
        <td>{{ t.risk_percent }}%</td>
        <td>{{ t.risk_reward_ratio }}</td>
        <td>
          {% if t.large_image %}
            <button type="button" class="p-0 border-0 bg-transparent"
                    data-bs-toggle="modal" data-bs-target="#imageModal"
                    data-img-src="{% url 'trades:image' t.pk 'ltf' %}"
                    data-img-title="{{ t.symbol }} — Large timeframe">
              <img src="{% url 'trades:image' t.pk 'ltf' %}" style="max-height:48px" class="me-1 rounded" alt="Large timeframe image">
            </button>
          {% endif %}
          {% if t.medium_image %}
            <button type="button" class="p-0 border-0 bg-transparent"
                    data-bs-toggle="modal" data-bs-target="#imageModal"
                    data-img-src="{% url 'trades:image' t.pk 'mtf' %}"
                    data-img-title="{{ t.symbol }} — Medium timeframe">
              <img src="{% url 'trades:image' t.pk 'mtf' %}" style="max-height:48px" class="me-1 rounded" alt="Medium timeframe image">
            </button>
          {% endif %}
          {% if t.short_image %}
            <button type="button" class="p-0 border-0 bg-transparent"
                    data-bs-toggle="modal" data-bs-target="#imageModal"
                    data-img-src="{% url 'trades:image' t.pk 'stf' %}"
                    data-img-title="{{ t.symbol }} — Short timeframe">
              <img src="{% url 'trades:image' t.pk 'stf' %}" style="max-height:48px" class="rounded" alt="Short timeframe image">
            </button>
          {% endif %}
        </td>
        <td>
          {% for tag in t.tags.all %}
            <span class="badge text-bg-secondary">{{ tag.name }}</span>
          {% empty %}
            <span class="text-muted">—</span>
          {% endfor %}
        </td>
        <td style="max-width: 280px">{{ t.comment }}</td>
        <td class="text-end">
          <a class="btn btn-sm btn-outline-secondary me-1" href="{% url 'trades:detail' t.pk %}">View</a>
          <a class="btn btn-sm btn-outline-primary" href="{% url 'trades:edit' t.pk %}">Edit</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="12" class="text-center text-muted py-4">No trades yet.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>

{% if is_paginated %}
  <nav>
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

  </div> <!-- /.col-lg-9 -->
</div> <!-- /.row -->

<!-- Image preview modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-0">
        <img id="imageModalImg" src="" class="img-fluid" alt="Trade image" style="max-height: 80vh; width: auto;">
      </div>
    </div>
  </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var modalEl = document.getElementById('imageModal');
    if (!modalEl) return;
    modalEl.addEventListener('show.bs.modal', function (event) {
      var trigger = event.relatedTarget;
      if (!trigger) return;
      var src = trigger.getAttribute('data-img-src');
      var title = trigger.getAttribute('data-img-title') || '';
      var imgEl = modalEl.querySelector('#imageModalImg');
      var titleEl = modalEl.querySelector('#imageModalLabel');
      if (imgEl) imgEl.src = src || '';
      if (titleEl) titleEl.textContent = title;
    });
    modalEl.addEventListener('hidden.bs.modal', function () {
      var imgEl = modalEl.querySelector('#imageModalImg');
      var titleEl = modalEl.querySelector('#imageModalLabel');
      if (imgEl) imgEl.src = '';
      if (titleEl) titleEl.textContent = '';
    });
  });
  </script>

{% endblock %}
